Goal:
I have a Telegram bot script that acts as a bridge between Telegram and a CLI script. The messages I send to the Telegram bot get passed to the CLI, and the CLI outputs are sent back to the Telegram bot. Currently, it sends me multiple repeated/spammy messages. I also want features for speed monitoring and proper error handling. Please patch the script without rewriting the entire code ‚Äî keep all original logic and only modify the necessary parts.


---

Requirements:

1. Fix Message Spam / Duplicate Output

Prevent duplicate or repeated CLI messages from being forwarded multiple times to Telegram.

Ensure that each CLI output is sent only once.



2. Rate Limit Message Sending

Add a 5-second delay between each Telegram message so the bot avoids rate-limit bans.



3. Download/Upload Speed Monitoring

After any download or upload starts, the bot should:

Measure the real internet speed consumed by the script (not dummy values).

Calculate the overall total speed (download + upload combined).

Send me this speed update every 2 minutes while the process is ongoing.


Stop updates once the task finishes.


‚úÖ Example format:

‚è≥ Download started...
üìä Current Internet Speed:
- Download: 12.4 MB/s
- Upload: 3.8 MB/s
- Total: 16.2 MB/s
(Updates every 2 min)


4. Error Handling & Solving

Catch and handle unexpected errors instead of crashing.

Specifically handle this error:


‚ùå Error: ‚ùå Uncaught Exception: [Error: Unknown system error -122: Unknown system error -122, write] {
  errno: -122,
  code: 'Unknown system error -122',
  syscall: 'write'
}

‚úÖ Required behavior:

Bot should not crash when this happens.

Retry the failed write operation automatically after a short delay (e.g., 2‚Äì5 seconds).

If retry fails multiple times, notify me on Telegram but keep the bot alive.


‚úÖ Example Telegram output:

‚ö†Ô∏è Warning: Write operation failed with system error -122.
Retrying in 5 seconds...

‚ùå Error: Persistent write failure (system error -122).
Action: Skipped this write. Bot is still running.


5. Keep Original Code Intact

Do not write a completely new script.

Do not change the overall structure or logic.

Only add or modify the specific parts needed to:

stop spam,

add 5s delays,

add speed monitoring,

add error handling & retry for error -122.






---

Extra Notes:

Script must still work for restricted Telegram messages.

Must remain stable in production.

Only small patches, not a full rewrite.



---

üìå Task: Patch my existing script with the above improvements while keeping all original functionality unchanged.